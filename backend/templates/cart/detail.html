{% extends "base.html" %}
{% load static %}

{% block title %}Your Cart | Arti Corner{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl px-4 sm:px-6 py-12">
    
    {# 1. Messages Block (Feedback for stock clamping) #}
    {% if messages %}
        <div class="mb-8 flex flex-col gap-2">
            {% for message in messages %}
                <div class="rounded-2xl px-5 py-3 text-sm 
                    {% if 'error' in message.tags or 'warning' in message.tags %}
                        bg-red-50 text-red-700 border border-red-100
                    {% else %}
                        bg-arti-dark/5 text-arti-dark border border-arti-dark/10
                    {% endif %}
                ">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div>
            <p class="text-xs font-bold tracking-[0.22em] text-arti-dark/60 uppercase">Cart</p>
            <h1 class="headline-serif mt-3 text-4xl">Your Cart</h1>
        </div>
        <a href="{% url 'product_list' %}" class="text-sm underline opacity-70 hover:opacity-100">
            Continue shopping
        </a>
    </div>

    {% if cart|length == 0 %}
        <div class="mt-10 rounded-3xl border border-arti-dark/10 bg-white p-8">
            <p class="text-arti-dark/70">Your cart is empty.</p>
            <a href="{% url 'product_list' %}" class="btn-primary mt-6 inline-flex">Browse products</a>
        </div>
    {% else %}
        <div class="mt-10 space-y-4">
            {% for item in cart %}
                {% with product=item.product %}
                    <div class="rounded-3xl border border-arti-dark/10 bg-white p-5 sm:p-6">
                        <div class="flex gap-4 sm:gap-6">
                            <a href="{{ product.get_absolute_url }}" class="h-20 w-20 sm:h-24 sm:w-24 rounded-2xl overflow-hidden bg-arti-dark/5 shrink-0">
                                <img
                                    src="{{ product.image_url_400 }}"
                                    srcset="{{ product.image_url_400 }} 400w, {{ product.image_url_800 }} 800w"
                                    sizes="(min-width: 640px) 96px, 80px"
                                    class="h-full w-full object-cover"
                                    alt="{{ product.name }}"
                                    loading="lazy"
                                    decoding="async"
                                />
                            </a>

                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="min-w-0">
                                        <a href="{{ product.get_absolute_url }}" class="font-medium hover:underline">
                                            {{ product.name }}
                                        </a>
                                        <p class="mt-1 text-xs uppercase tracking-widest opacity-60">
                                            {{ product.category.name }}
                                        </p>
                                        <p class="mt-3 text-sm opacity-70">
                                            €{{ product.price }} <span class="opacity-50">each</span>
                                        </p>
                                    </div>

                                    <div class="text-right shrink-0">
                                        <p class="font-medium text-lg">€{{ item.total_price }}</p>
                                        <p class="text-xs uppercase tracking-widest opacity-50 mt-1">Line total</p>
                                    </div>
                                </div>

                                <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                    <div class="flex items-center gap-3">
                                        <form method="post" action="{% url 'cart_update' product.id %}" class="flex items-center gap-2">
                                            {% csrf_token %}
                                            <label class="sr-only" for="qty-{{ product.id }}">Quantity</label>
                                            <input
                                                id="qty-{{ product.id }}"
                                                name="qty"
                                                type="number"
                                                min="1"
                                                max="{{ item.max_qty }}"
                                                value="{{ item.qty }}"
                                                inputmode="numeric"
                                                class="w-20 rounded-2xl border border-arti-dark/15 bg-white px-4 py-3 text-center text-sm focus:border-arti-dark focus:ring-0 invalid:border-red-400 invalid:text-red-600"
                                            >
                                            <button class="rounded-2xl border border-arti-dark/15 bg-white px-5 py-3 text-sm font-medium hover:border-arti-dark transition">
                                                Update
                                            </button>
                                        </form>

                                        <form method="post" action="{% url 'cart_remove' product.id %}">
                                            {% csrf_token %}
                                            <button
                                                type="submit"
                                                class="group flex items-center justify-center rounded-2xl border border-arti-dark/15 bg-white p-3 
                                                       hover:border-red-200 hover:bg-red-50 transition
                                                       focus:outline-none focus:ring-2 focus:ring-red-200 focus:ring-offset-2"
                                                aria-label="Remove {{ product.name }} from cart"
                                                title="Remove"
                                            >
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    class="h-5 w-5 text-arti-dark/50 group-hover:text-red-600 transition"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21
                                                             c.342.052.682.107 1.022.166M4.978 5.79
                                                             c.34-.059.68-.114 1.022-.166m0 0
                                                             a48.108 48.108 0 0 1 3.478-.397
                                                             m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201
                                                             a51.964 51.964 0 0 0-3.32 0
                                                             c-1.18.037-2.09 1.022-2.09 2.201v.916
                                                             m7.5 0a48.667 48.667 0 0 0-7.5 0"
                                                    />
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endwith %}
            {% endfor %}
        </div>

        <div class="mt-10 rounded-3xl border border-arti-dark/10 bg-white p-6 sm:p-7">
            <div class="flex flex-col gap-6 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <p class="text-xs uppercase tracking-widest opacity-60">Total</p>
                    <p class="headline-serif mt-2 text-4xl">€{{ cart.get_total_price }}</p>
                    <p class="mt-2 text-sm opacity-60">Shipping and taxes calculated at checkout.</p>
                </div>

                <div class="flex flex-col gap-3 w-full sm:w-auto">
                    {# Checkout Start Form - Correctly Sized #}
                    <form method="post" action="{% url 'checkout_start' %}" class="w-full sm:w-auto">
                        {% csrf_token %}
                        <button type="submit" class="btn-primary w-full sm:w-auto px-10">Checkout</button>
                    </form>
                    
                    <a href="{% url 'product_list' %}" class="btn-outline w-full sm:w-auto px-10">Keep shopping</a>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}