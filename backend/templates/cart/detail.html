{% extends "base.html" %}
{% load static %}

{% block title %}Your Cart | Art Leptis{% endblock %}

{% block content %}
<section class="artleptis">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 py-section-sm">

        {# ── HEADER ── #}
        <div class="reveal-up">
            <div class="flex items-end justify-between">
                <div>
                    <p class="label">Shopping Cart</p>
                    <h1 class="headline-serif mt-3 text-4xl sm:text-5xl">Your Cart</h1>
                </div>
                <a href="{% url 'product_list' %}"
                     class="text-[11px] font-bold uppercase tracking-[0.12em] border-b border-rule pb-0.5 hover:border-ink transition-colors">
                    Continue Shopping
                </a>
            </div>
            <div class="rule mt-6"></div>
        </div>

        {# ── EMPTY STATE ── #}
        {% if cart|length == 0 %}
            <div class="reveal-up mt-10 border border-rule bg-paper p-12 text-center">
                <p class="text-meta">STATUS</p>
                <p class="text-ink-60 text-lg mt-3">Your cart is currently empty.</p>
                <div class="rule mx-auto max-w-24 mt-6"></div>
                <a href="{% url 'product_list' %}" class="btn-primary mt-6">Start Browsing</a>
            </div>

        {% else %}

            {# ── ITEM COUNT META ── #}
            <div class="mt-6 flex items-center justify-between">
                <p class="text-meta">{{ cart|length }} ITEM{{ cart|length|pluralize }}</p>
                <p class="text-meta">REF. CART</p>
            </div>

            {# ── LINE ITEMS ── #}
            <div class="mt-6 space-y-0">
                {% for item in cart %}
                    {% with product=item.product %}
                        <div class="reveal-up border border-rule bg-paper p-5 sm:p-6 flex flex-col sm:flex-row gap-5 sm:gap-6 -mt-px">

                            {# Image #}
                            <a href="{{ product.get_absolute_url }}"
                                 class="plate block h-28 w-28 min-w-28 shrink-0 overflow-hidden">
                                <img
                                    src="{{ product.image_url_400 }}"
                                    class="h-full w-full object-cover"
                                    alt="{{ product.image_alt }}"
                                    loading="lazy"
                                />
                            </a>

                            {# Details #}
                            <div class="flex flex-1 flex-col justify-between min-w-0">

                                {# Top row: name + price #}
                                <div class="flex justify-between items-start gap-4">
                                    <div class="min-w-0">
                                        <p class="text-meta mb-1">{{ product.category.name }}</p>
                                        <h3 class="font-serif text-xl leading-tight">
                                            <a href="{{ product.get_absolute_url }}" class="hover:text-ink-80 transition-colors">
                                                {{ product.name }}
                                            </a>
                                        </h3>
                                    </div>
                                    <p class="font-bold text-lg shrink-0 tabular-nums">€{{ item.total_price }}</p>
                                </div>

                                {# Bottom row: qty + remove #}
                                <div class="flex items-center justify-between mt-4 pt-4 border-t border-rule">

                                    {# Quantity stepper #}
                                    <div class="flex items-center border border-rule">
                                        <form method="post" action="{% url 'cart_update' product.id %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="qty" value="{{ item.qty|add:'-1' }}">
                                            <button
                                                class="w-9 h-9 flex items-center justify-center text-ink hover:bg-ink-05 transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                                                {% if item.qty <= 1 %}disabled{% endif %}
                                                aria-label="Decrease quantity"
                                            >−</button>
                                        </form>

                                        <span
                                            data-testid="cart-line-qty-{{ product.id }}"
                                            class="w-10 h-9 flex items-center justify-center text-sm font-bold border-x border-rule tabular-nums"
                                        >
                                            {{ item.qty }}
                                        </span>

                                        <form method="post" action="{% url 'cart_update' product.id %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="qty" value="{{ item.qty|add:'1' }}">
                                            <button
                                                class="w-9 h-9 flex items-center justify-center text-ink hover:bg-ink-05 transition-colors"
                                                aria-label="Increase quantity"
                                            >+</button>
                                        </form>
                                    </div>

                                    {# Remove #}
                                    <form method="post" action="{% url 'cart_remove' product.id %}">
                                        {% csrf_token %}
                                        <button class="text-[11px] font-bold uppercase tracking-[0.12em] text-ink-60 border-b border-rule pb-0.5 hover:text-ink hover:border-ink transition-colors">
                                            Remove
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endwith %}
                {% endfor %}
            </div>

            {# ── SUMMARY / CHECKOUT ── #}
            <div class="reveal-up mt-10 bg-ink-inverted bg-ink text-paper p-8 sm:p-10 border border-ink">
                <div class="flex flex-col gap-6 sm:flex-row sm:items-end sm:justify-between">
                    <div>
                        <p class="text-meta text-slate-400!">Total Amount</p>
<p class="headline-serif mt-2 text-5xl text-paper! tabular-nums">€{{ cart.get_total_price }}</p>

                        <p class="mt-3 text-sm text-slate-400">Shipping and taxes calculated at checkout.</p>
                    </div>

                    <form method="post" action="{% url 'checkout_start' %}" class="w-full sm:w-auto">
                        {% csrf_token %}
                        <button type="submit" class="btn-signal w-full sm:w-auto">
                            Proceed to Checkout
                        </button>
                    </form>
                </div>
            </div>

            {# ── TECHNICAL FOOTER ── #}
            <div class="mt-4 flex items-center justify-between">
                <p class="text-meta">SEC. CART</p>
                <p class="text-meta">Art Leptis</p>
            </div>

        {% endif %}
    </div>
</section>
{% endblock %}