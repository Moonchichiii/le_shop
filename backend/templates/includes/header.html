{% load i18n %}
<header
  class="fixed top-0 left-0 w-full z-40 transition-all duration-300"
  x-data="{ scrolled: false, mobileOpen: false, accountOpen: false, langOpen: false }"
  @scroll.window="scrolled = (window.pageYOffset > 20)"
  @keydown.escape.window="mobileOpen = false; accountOpen = false; langOpen = false"
  :class="scrolled ? 'nav-glass py-3' : 'bg-transparent py-5'"
>
  <div class="max-w-7xl mx-auto px-6 flex items-center justify-between">

    <!-- Logo -->
    <a href="/" class="font-serif text-2xl font-bold tracking-tight text-arti-ink hover:opacity-80 transition">
      Art Leptis<span class="text-primary-600">.</span>
    </a>

    <!-- Desktop Nav (no auth links here) -->
    <nav class="hidden md:flex items-center gap-8 text-sm font-medium text-arti-ink/80">
      <a href="{% url 'product_list' %}" class="hover:text-arti-ink transition">Shop</a>
      <a href="#story" class="hover:text-arti-ink transition">About</a>
      <a href="#" class="hover:text-arti-ink transition">Journal</a>
    </nav>

    <!-- Actions -->
    <div class="flex items-center gap-3">

      <!-- Search -->
      <button
        type="button"
        @click="$dispatch('open-search')"
        class="hover:opacity-70 transition text-arti-ink"
        aria-label="Search"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>

      <!-- Bag / Cart -->
      <a href="{% url 'cart_detail' %}" class="relative hover:opacity-70 transition text-arti-ink" aria-label="Cart">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
        </svg>

        {% if cart and cart|length > 0 %}
          <span class="absolute -top-1 -right-1 min-w-5 h-5 px-1 rounded-full bg-orange-400 text-[10px] font-bold flex items-center justify-center">
            {{ cart|length }}
          </span>
        {% else %}
          <span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-orange-400 rounded-full"></span>
        {% endif %}
      </a>

      <!-- Language Switcher (DESKTOP) - FIXED -->
      <div class="hidden md:relative md:block" @click.outside="langOpen = false">
        <button
          type="button"
          class="inline-flex items-center gap-1.5 text-arti-ink hover:text-primary-600 transition"
          aria-label="Change language"
          :aria-expanded="langOpen.toString()"
          aria-haspopup="menu"
          @click="langOpen = !langOpen; accountOpen = false"
        >
          <!-- Globe Icon (cleaner) -->
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 21c4.97 0 9-4.03 9-9s-4.03-9-9-9-9 4.03-9 9 4.03 9 9 9Z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12h18"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 3c2.5 2.7 4 5.9 4 9s-1.5 6.3-4 9c-2.5-2.7-4-5.9-4-9s1.5-6.3 4-9Z"/>
          </svg>

          <!-- Current Lang Code -->
          {% get_current_language as LANGUAGE_CODE %}
          <span class="text-[10px] font-bold uppercase tracking-widest leading-none">
            {{ LANGUAGE_CODE|upper }}
          </span>

          <!-- Chevron (down arrow) -->
          <svg
            class="h-4 w-4 transition-transform duration-200"
            :class="langOpen ? 'rotate-180' : 'rotate-0'"
            viewBox="0 0 20 20"
            fill="currentColor"
            aria-hidden="true"
          >
            <path fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.17l3.71-3.94a.75.75 0 1 1 1.08 1.04l-4.25 4.5a.75.75 0 0 1-1.08 0l-4.25-4.5a.75.75 0 0 1 .02-1.06Z"
                  clip-rule="evenodd"/>
          </svg>
        </button>

        <div
          x-show="langOpen"
          x-transition.opacity
          x-cloak
          @keydown.escape.stop="langOpen = false"
          class="absolute right-0 mt-3 w-28 rounded-2xl border border-arti-ink/10 bg-white shadow-xl overflow-hidden"
          role="menu"
          style="display:none"
        >
          <form method="post" action="{% url 'set_language' %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">

            <button
              name="language"
              value="en"
              class="w-full px-4 py-2 text-left text-sm hover:bg-arti-ink/5 transition"
              role="menuitem"
            >
              English
            </button>

            <button
              name="language"
              value="fr"
              class="w-full px-4 py-2 text-left text-sm hover:bg-arti-ink/5 transition"
              role="menuitem"
            >
              Français
            </button>
          </form>
        </div>
      </div>

      <!-- Account dropdown (DESKTOP ONLY) -->
      <div class="hidden md:relative md:block" @click.outside="accountOpen = false">
        <button
          type="button"
          class="hover:opacity-70 transition text-arti-ink"
          aria-label="Account"
          :aria-expanded="accountOpen.toString()"
          aria-haspopup="menu"
          @click="accountOpen = !accountOpen; langOpen = false"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </button>

        <div
          x-show="accountOpen"
          x-transition.opacity
          x-cloak
          @keydown.escape.stop="accountOpen = false"
          class="absolute right-0 mt-3 w-56 rounded-3xl border border-arti-ink/10 bg-white shadow-xl overflow-hidden"
          role="menu"
          style="display:none"
        >
          {% if request.user.is_authenticated %}
            <div class="px-4 py-3 border-b border-arti-ink/10">
              <p class="text-xs uppercase tracking-widest opacity-60">Signed in</p>
              <p class="text-sm font-medium truncate">{{ request.user.email }}</p>
            </div>

            <a href="#" class="block px-4 py-3 text-sm hover:bg-arti-ink/5" role="menuitem">
              Account
            </a>
            <a href="{% url 'orders_list' %}" class="block px-4 py-3 text-sm hover:bg-arti-ink/5" role="menuitem">
              Orders
            </a>

            <form method="post" action="{% url 'account_logout' %}" class="border-t border-arti-ink/10">
              {% csrf_token %}
              <button type="submit" class="w-full text-left px-4 py-3 text-sm hover:bg-arti-ink/5">
                Sign out
              </button>
            </form>
          {% else %}
            <a href="{% url 'account_login' %}" class="block px-4 py-3 text-sm hover:bg-arti-ink/5" role="menuitem">
              Sign in
            </a>
            <a href="{% url 'account_signup' %}" class="block px-4 py-3 text-sm hover:bg-arti-ink/5" role="menuitem">
              Create account
            </a>
          {% endif %}
        </div>
      </div>

      <!-- Mobile Hamburger -->
      <button
        type="button"
        class="md:hidden relative inline-flex items-center justify-center h-11 w-11 rounded-full text-arti-ink hover:bg-arti-ink/5 transition focus:outline-none focus:ring-2 focus:ring-primary-500"
        @click="mobileOpen = !mobileOpen"
        :aria-expanded="mobileOpen.toString()"
        aria-controls="mobile-menu"
        :aria-label="mobileOpen ? 'Close menu' : 'Open menu'"
      >
        <span class="sr-only" x-text="mobileOpen ? 'Close menu' : 'Open menu'"></span>

        <!-- 3 bars -> X (Alpine driven) -->
        <span aria-hidden="true"
              class="absolute left-1/2 top-1/2 block h-0.5 w-6 -translate-x-1/2 -translate-y-1/2 rounded-full bg-arti-ink transition-all duration-300"
              :class="mobileOpen ? 'rotate-45' : '-translate-y-2.5'"></span>

        <span aria-hidden="true"
              class="absolute left-1/2 top-1/2 block h-0.5 w-6 -translate-x-1/2 -translate-y-1/2 rounded-full bg-arti-ink transition-all duration-300"
              :class="mobileOpen ? 'opacity-0 scale-x-0' : 'opacity-100 scale-x-100'"></span>

        <span aria-hidden="true"
              class="absolute left-1/2 top-1/2 block h-0.5 w-6 -translate-x-1/2 -translate-y-1/2 rounded-full bg-arti-ink transition-all duration-300"
              :class="mobileOpen ? '-rotate-45' : 'translate-y-2.5'"></span>

      </button>
    </div>
  </div>

  <!-- Mobile Menu Backdrop -->
  <div
    x-show="mobileOpen"
    x-transition.opacity
    class="fixed inset-0 bg-black/30 md:hidden"
    @click="mobileOpen = false"
    style="display:none"
  ></div>

  <!-- Mobile Drawer -->
  <div
    id="mobile-menu"
    x-show="mobileOpen"
    x-transition:enter="transition ease-out duration-250"
    x-transition:enter-start="opacity-0 -translate-y-2"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 -translate-y-2"
    class="md:hidden absolute left-0 right-0 top-full px-4"
    style="display:none"
  >
    <div class="mt-3 rounded-3xl border border-arti-ink/10 bg-white p-4 shadow-xl">
      <a href="{% url 'product_list' %}" class="block px-4 py-3 rounded-2xl hover:bg-arti-ink/5">Shop</a>
      <a href="#" class="block px-4 py-3 rounded-2xl hover:bg-arti-ink/5">About</a>
      <a href="#" class="block px-4 py-3 rounded-2xl hover:bg-arti-ink/5">Journal</a>

      <div class="mt-2 border-t border-arti-ink/10 pt-2">
        <a href="{% url 'cart_detail' %}" class="block px-4 py-3 rounded-2xl hover:bg-arti-ink/5">Cart</a>

        {% if request.user.is_authenticated %}
          <a href="{% url 'orders_list' %}" class="block px-4 py-3 rounded-2xl hover:bg-arti-ink/5">Orders</a>
          <form method="post" action="{% url 'account_logout' %}">
            {% csrf_token %}
            <button type="submit" class="w-full text-left block px-4 py-3 rounded-2xl hover:bg-arti-ink/5">
              Sign out
            </button>
          </form>
        {% else %}
          <a href="{% url 'account_login' %}" class="block px-4 py-3 rounded-2xl hover:bg-arti-ink/5">Sign in</a>
          <a href="{% url 'account_signup' %}" class="block px-4 py-3 rounded-2xl hover:bg-arti-ink/5">Create account</a>
        {% endif %}
      </div>

      <!-- Language switcher (MOBILE) -->
      <div class="mt-2 border-t border-arti-ink/10 pt-2">
        <form method="post" action="{% url 'set_language' %}">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">

          <button name="language" value="en" class="block w-full text-left px-4 py-3 rounded-2xl hover:bg-arti-ink/5">
            English
          </button>
          <button name="language" value="fr" class="block w-full text-left px-4 py-3 rounded-2xl hover:bg-arti-ink/5">
            Français
          </button>
        </form>
      </div>
    </div>
  </div>
</header>
