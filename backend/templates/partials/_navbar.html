{% load i18n %}
<header
  class="fixed top-0 left-0 w-full z-40 transition-all duration-300"
  x-data="{
    scrolled: false,
    mobileOpen: false,
    mobileShopOpen: false,
    accountOpen: false,
    langOpen: false,
    shopOpen: false,
    searchOpen: false,
  }"
  @scroll.window="scrolled = (window.pageYOffset > 20)"
  @search-opened.window="searchOpen = true"
  @search-closed.window="searchOpen = false"
  @keydown.escape.window="
    mobileOpen = false;
    accountOpen = false;
    langOpen = false;
    shopOpen = false;
  "
  :class="scrolled
    ? 'bg-paper/95 backdrop-blur-md shadow-sm'
    : 'bg-paper'"
>
  <div
    class="border-b border-rule/60 transition-all duration-300"
    :class="scrolled ? 'py-2' : 'py-3'"
  >
    <div
      class="max-w-[1400px] mx-auto px-5 md:px-6
             flex items-center relative"
    >
      {# LEFT — Nav links (desktop) / Logo (mobile) #}
      <div class="flex items-center gap-1 md:flex-1 min-w-0">
        {# Logo — visible on mobile only in this slot #}
        <a
          href="/"
          class="md:hidden font-serif text-[1.4rem] font-medium
                 tracking-tight text-ink hover:opacity-70
                 transition-opacity whitespace-nowrap"
        >
          Art Leptis
        </a>

        {# Desktop nav #}
        <nav
          class="hidden md:flex items-center gap-0.5"
          aria-label="Main"
        >
          {# Shop dropdown #}
          <div class="relative" @click.outside="shopOpen = false">
            <button
              type="button"
              class="header-nav-link inline-flex items-center
                     gap-1.5"
              @click="shopOpen = !shopOpen"
              :aria-expanded="shopOpen.toString()"
            >
              <svg
                class="w-[15px] h-[15px] opacity-50"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3.75 6.75h16.5M3.75 12h16.5m-16.5
                     5.25h16.5"
                />
              </svg>
              Shop
            </button>

            <div
              x-show="shopOpen"
              x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 -translate-y-2"
              x-transition:enter-end="opacity-100 translate-y-0"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100"
              x-transition:leave-end="opacity-0 -translate-y-2"
              x-cloak
              class="absolute left-0 mt-3 w-56 bg-surface border
                     border-rule/60 shadow-lg p-2"
              style="border-radius: var(--radius-lg)"
              role="menu"
            >
              <a
                href="{% url 'product_list' %}"
                class="block px-4 py-3 text-lg font-serif
                       hover:bg-ink-05 transition-colors"
                style="border-radius: var(--radius-md)"
                role="menuitem"
              >
                Shop All
              </a>
            </div>
          </div>

          <a href="/#story" class="header-nav-link">Our Story</a>
        </nav>
      </div>

      {# CENTER — Logo (desktop only, truly centered) #}       
              <a
        href="/"
        class="hidden md:block absolute left-1/2 top-1/2
               -translate-x-1/2 -translate-y-1/2
               font-serif text-[1.7rem] font-medium
               tracking-tight text-ink hover:opacity-70
               transition-opacity whitespace-nowrap z-10"
      >
        Art Leptis
      </a>

      {# RIGHT — Actions #}
      <div
        class="flex items-center gap-2 md:gap-3 ml-auto
               md:flex-1 md:justify-end"
      >
        {# ── Search icon (all sizes) ── #}
        <button
          type="button"
          @click="
            if (searchOpen) {
              $dispatch('close-search');
            } else {
              $dispatch('open-search');
            }
          "
          class="header-icon-btn"
          aria-label="Search"
        >
          {# Magnifying glass (default) #}
          <svg
            x-show="!searchOpen"
            class="w-[19px] h-[19px]"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0
                 0114 0z"
            />
          </svg>
          {# X when search open (desktop hint) #}
          <svg
            x-show="searchOpen"
            x-cloak
            class="w-[19px] h-[19px]"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>

        {# ── Cart — circled count (mobile) ── #}
        <a
          href="{% url 'cart_detail' %}"
          class="md:hidden header-icon-btn"
          aria-label="Cart"
        >
          <span
            class="w-[25px] h-[25px] rounded-full border
                   border-ink/25 inline-flex items-center
                   justify-center text-[10px] font-semibold
                   text-ink-60 leading-none"
          >
            {{ cart|length|default:"0" }}
          </span>
        </a>

        {# ── Cart — text (desktop) ── #}
        <a
          href="{% url 'cart_detail' %}"
          class="hidden md:inline-flex items-center gap-0.5
                 text-[0.8125rem] font-medium text-ink-60
                 hover:text-ink transition-colors
                 py-1.5 px-1"
        >
          Cart
          <span class="text-ink-40 ml-0.5">
            ({{ cart|length|default:"0" }})
          </span>
        </a>

        {# ── Language toggle (desktop) ── #}
        <div
          class="hidden md:relative md:block"
          @click.outside="langOpen = false"
        >
          <button
            type="button"
            class="inline-flex items-center gap-1
                   text-[0.8125rem] font-medium text-ink-60
                   hover:text-ink transition-colors
                   py-1.5 px-1"
            @click="langOpen = !langOpen; accountOpen = false"
            :aria-expanded="langOpen.toString()"
            aria-label="Change language"
          >
            {% get_current_language as LANGUAGE_CODE %}
            <span>{{ LANGUAGE_CODE|upper }}</span>
            <svg
              class="w-3 h-3 transition-transform duration-200"
              :class="langOpen ? 'rotate-180' : ''"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10
                   11.17l3.71-3.94a.75.75 0 111.08
                   1.04l-4.25 4.5a.75.75 0 01-1.08
                   0l-4.25-4.5a.75.75 0 01.02-1.06Z"
                clip-rule="evenodd"
              />
            </svg>
          </button>

          <div
            x-show="langOpen"
            x-transition
            x-cloak
            class="absolute right-0 mt-3 w-32 bg-surface border
                   border-rule/60 shadow-lg overflow-hidden"
            style="border-radius: var(--radius-lg)"
            role="menu"
          >
            <form method="post" action="{% url 'set_language' %}">
              {% csrf_token %}
              <input
                type="hidden"
                name="next"
                value="{{ request.get_full_path }}"
              />
              <button
                name="language"
                value="en"
                class="w-full px-4 py-2.5 text-left text-sm
                       hover:bg-ink-05 transition"
                style="border-radius: var(--radius-md)"
                role="menuitem"
              >
                English
              </button>
              <button
                name="language"
                value="fr"
                class="w-full px-4 py-2.5 text-left text-sm
                       hover:bg-ink-05 transition"
                style="border-radius: var(--radius-md)"
                role="menuitem"
              >
                Français
              </button>
            </form>
          </div>
        </div>

        {# ── Account icon (desktop) ── #}
        <div
          class="hidden md:relative md:block"
          @click.outside="accountOpen = false"
        >
          <button
            type="button"
            class="header-icon-btn"
            @click="accountOpen = !accountOpen; langOpen = false"
            :aria-expanded="accountOpen.toString()"
            aria-label="Account"
          >
            <svg
              class="w-[18px] h-[18px]"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M16 7a4 4 0 11-8 0 4 4 0
                   018 0zM12 14a7 7 0 00-7 7h14a7
                   7 0 00-7-7z"
              />
            </svg>
          </button>

          <div
            x-show="accountOpen"
            x-transition
            x-cloak
            class="absolute right-0 mt-3 w-56 bg-surface border
                   border-rule/60 shadow-lg overflow-hidden"
            style="border-radius: var(--radius-lg)"
            role="menu"
          >
            {% if request.user.is_authenticated %}
              <div
                class="px-4 py-3 border-b border-rule
                       bg-cream/50"
              >
                <p class="text-xs text-ink-40 font-medium">
                  Signed in as
                </p>
                <p class="text-sm font-medium truncate mt-0.5">
                  {{ request.user.email }}
                </p>
              </div>
              <a
                href="#"
                class="block px-4 py-3 text-sm hover:bg-ink-05
                       transition"
                style="border-radius: var(--radius-md)"
                role="menuitem"
              >
                Account
              </a>
              <a
                href="{% url 'orders_list' %}"
                class="block px-4 py-3 text-sm hover:bg-ink-05
                       transition"
                style="border-radius: var(--radius-md)"
                role="menuitem"
              >
                Orders
              </a>
              <form
                method="post"
                action="{% url 'account_logout' %}"
                class="border-t border-rule"
              >
                {% csrf_token %}
                <button
                  type="submit"
                  class="w-full text-left px-4 py-3 text-sm
                         hover:bg-ink-05 transition"
                >
                  Sign out
                </button>
              </form>
            {% else %}
              <a
                href="{% url 'account_login' %}"
                class="block px-4 py-3 text-sm hover:bg-ink-05
                       transition"
                role="menuitem"
              >
                Sign in
              </a>
              <a
                href="{% url 'account_signup' %}"
                class="block px-4 py-3 text-sm hover:bg-ink-05
                       transition"
                role="menuitem"
              >
                Create account
              </a>
            {% endif %}
          </div>
        </div>

        {# ── Hamburger (mobile) ── #}
        <button
          type="button"
          class="md:hidden header-icon-btn"
          @click="mobileOpen = !mobileOpen"
          :aria-expanded="mobileOpen.toString()"
          aria-controls="mobile-menu"
          :aria-label="mobileOpen ? 'Close menu' : 'Open menu'"
        >
          <span
            aria-hidden="true"
            class="absolute block h-[1.5px] w-[17px] bg-ink
                   transition-all duration-300 ease-out"
            :class="mobileOpen
              ? 'rotate-45 translate-y-0'
              : '-translate-y-[5px]'"
          ></span>
          <span
            aria-hidden="true"
            class="absolute block h-[1.5px] w-[17px] bg-ink
                   transition-all duration-300 ease-out"
            :class="mobileOpen
              ? 'opacity-0 scale-x-0'
              : 'opacity-100'"
          ></span>
          <span
            aria-hidden="true"
            class="absolute block h-[1.5px] w-[17px] bg-ink
                   transition-all duration-300 ease-out"
            :class="mobileOpen
              ? '-rotate-45 translate-y-0'
              : 'translate-y-[5px]'"
          ></span>
        </button>
      </div>
    </div>
  </div>

  {# MOBILE FULL-SCREEN MENU #}
  <div
    id="mobile-menu"
    x-show="mobileOpen"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="md:hidden fixed inset-0 z-30 bg-surface
           overflow-y-auto overscroll-contain"
    style="display: none"
  >
    {# Menu header — mirrors main bar #}
    <div class="border-b border-rule/60 py-3">
      <div class="px-5 flex items-center">
        <a
          href="/"
          class="font-serif text-[1.4rem] font-medium
                 tracking-tight text-ink"
        >
          Art Leptis
        </a>

        <div class="flex items-center gap-2 ml-auto">
          <button
            type="button"
            @click="
              mobileOpen = false;
              $nextTick(() => $dispatch('open-search'));
            "
            class="header-icon-btn"
            aria-label="Search"
          >
            <svg
              class="w-[19px] h-[19px]"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0
                   0114 0z"
              />
            </svg>
          </button>

          <a
            href="{% url 'cart_detail' %}"
            class="header-icon-btn"
            aria-label="Cart"
          >
            <span
              class="w-[25px] h-[25px] rounded-full border
                     border-ink/25 inline-flex items-center
                     justify-center text-[10px] font-semibold
                     text-ink-60 leading-none"
            >
              {{ cart|length|default:"0" }}
            </span>
          </a>

          <button
            type="button"
            @click="mobileOpen = false"
            class="header-icon-btn"
            aria-label="Close menu"
          >
            <svg
              class="w-[18px] h-[18px]"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>

    {# Navigation #}
    <nav class="px-5 pt-4" aria-label="Mobile navigation">
      {# Shop — expandable #}
      <div class="border-b border-rule/40">
        <button
          type="button"
          class="w-full flex items-center justify-between py-5"
          @click="mobileShopOpen = !mobileShopOpen"
          :aria-expanded="mobileShopOpen.toString()"
        >
          <span
            class="font-serif text-[1.6rem] font-medium text-ink"
          >
            Shop
          </span>
          <span
            class="w-7 h-7 rounded-full border border-ink/15
                   inline-flex items-center justify-center
                   transition-transform duration-300"
            :class="mobileShopOpen ? 'rotate-45' : ''"
          >
            <svg
              class="w-3 h-3 text-ink-40"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 4.5v15m7.5-7.5h-15"
              />
            </svg>
          </span>
        </button>

        <div x-show="mobileShopOpen" x-collapse x-cloak>
          <div class="pb-4 pl-1 space-y-1">
            <a
              href="{% url 'product_list' %}"
              @click="mobileOpen = false"
              class="block py-2.5 text-lg text-ink-60
                     hover:text-ink transition-colors"
            >
              Shop All
            </a>
          </div>
        </div>
      </div>

      {# Pages — expandable (like Ceramika) #}
      <div class="border-b border-rule/40">
        <a
          href="/#story"
          @click="mobileOpen = false"
          class="block py-5 font-serif text-[1.6rem]
                 font-medium text-ink"
        >
          Our Story
        </a>
      </div>

      <div class="border-b border-rule/40">
        <a
          href="/#magazine"
          @click="mobileOpen = false"
          class="block py-5 font-serif text-[1.6rem]
                 font-medium text-ink"
        >
          Magazine
        </a>
      </div>

      {# Secondary links #}
      <div class="pt-6 space-y-0.5">
        {% if request.user.is_authenticated %}
          <div
            class="mb-4 px-4 py-3 bg-cream/60"
            style="border-radius: var(--radius-md)"
          >
            <p class="text-xs text-ink-40 font-medium">
              Signed in as
            </p>
            <p class="text-sm font-medium truncate mt-0.5">
              {{ request.user.email }}
            </p>
          </div>
          <a
            href="{% url 'orders_list' %}"
            @click="mobileOpen = false"
            class="block py-2.5 text-sm font-medium
                   text-ink-60 hover:text-ink transition-colors"
          >
            Orders
          </a>
          <a
            href="#"
            @click="mobileOpen = false"
            class="block py-2.5 text-sm font-medium
                   text-ink-60 hover:text-ink transition-colors"
          >
            Account
          </a>
          <form method="post" action="{% url 'account_logout' %}">
            {% csrf_token %}
            <button
              type="submit"
              class="block py-2.5 text-sm font-medium
                     text-ink-60 hover:text-ink transition-colors"
            >
              Sign out
            </button>
          </form>
        {% else %}
          <a
            href="{% url 'account_login' %}"
            @click="mobileOpen = false"
            class="block py-2.5 text-sm font-medium
                   text-ink-60 hover:text-ink transition-colors"
          >
            Sign in
          </a>
          <a
            href="{% url 'account_signup' %}"
            @click="mobileOpen = false"
            class="block py-2.5 text-sm font-medium
                   text-ink-60 hover:text-ink transition-colors"
          >
            Create account
          </a>
        {% endif %}
      </div>

      {# Language #}
      <div class="pt-6 pb-10">
        <form method="post" action="{% url 'set_language' %}">
          {% csrf_token %}
          <input
            type="hidden"
            name="next"
            value="{{ request.get_full_path }}"
          />
          <div class="flex gap-2">
            <button
              name="language"
              value="en"
              class="pill flex-1 justify-center py-2.5"
            >
              EN
            </button>
            <button
              name="language"
              value="fr"
              class="pill flex-1 justify-center py-2.5"
            >
              FR
            </button>
          </div>
        </form>
      </div>
    </nav>
  </div>
</header>