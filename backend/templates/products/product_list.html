{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Shop" %} | Art Leptis{% endblock %}

{% block content %}
<section class="bg-paper py-section-sm">
  <div class="px-6 md:px-12 lg:px-20">

    {# HEADER + SEARCH #}
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-6
                reveal-up">
      <div>
        <p class="label">{% trans "Shop" %}</p>
        <h1 class="headline-serif mt-3 text-4xl md:text-5xl lg:text-6xl">
          {% trans "Curated Objects" %}
        </h1>
      </div>

      <form method="get" class="hidden md:flex items-center gap-2">
        <input
          type="text"
          name="q"
          value="{{ query }}"
          placeholder="{% trans 'Search...' %}"
          class="border border-rule bg-surface px-5 py-2.5 text-sm w-64
                 focus:border-ink focus:ring-1 focus:ring-ink
                 outline-none transition-colors"
        />
        {% if active_category %}
          <input type="hidden" name="category" value="{{ active_category }}">
        {% endif %}
        <button class="btn-outline px-6 py-2.5">{% trans "Search" %}</button>
      </form>
    </div>

    {# CATEGORY FILTERS #}
    <div class="mt-8 reveal-up">
      <div class="divider"></div>

      <nav class="mt-6 flex flex-wrap gap-2"
           aria-label="{% trans 'Product filters' %}">
        <a href="{% url 'product_list' %}"
           class="pill {% if not active_category %}pill--active{% endif %}">
          {% trans "All" %}
        </a>
        {% for c in categories %}
          <a href="{% url 'product_list' %}?category={{ c.slug }}"
             class="pill {% if active_category == c.slug %}pill--active{% endif %}">
            {{ c.name }}
          </a>
        {% endfor %}
      </nav>
    </div>

    {# PRODUCT GRID #}
    <div class="mt-12 grid gap-x-6 gap-y-12 sm:grid-cols-2 lg:grid-cols-3
                lg:gap-x-8 lg:gap-y-16">

      {% for p in products %}

        {# ── Featured card: first item spans 2 cols ── #}
        {% if forloop.first %}
          <article class="product-card md:col-span-2 lg:col-span-2 reveal-up">
            <a href="{{ p.get_absolute_url }}" class="block group">

              {# Frame — wider ratio for featured #}
              <div class="product-card__frame" style="aspect-ratio: 3 / 2;">
                <img
                  src="{{ p.image_url_400 }}"
                  srcset="{{ p.image_url_400 }} 400w, {{ p.image_url_800 }} 800w"
                  sizes="(min-width: 1024px) 66vw, (min-width: 640px) 100vw, 100vw"
                  alt="{{ p.name }}"
                  loading="eager"
                  decoding="async"
                >

                {# Badges #}
                {% if not p.is_in_stock %}
                  <div class="absolute top-3 left-3 z-10">
                    <span class="badge badge--sold-out">{% trans "Sold Out" %}</span>
                  </div>
                {% endif %}

                {# Quick add — featured gets a full button below #}
                {% if p.is_in_stock %}
                  <div class="absolute bottom-4 right-4 translate-y-4 opacity-0
                              transition-all duration-300
                              group-hover:translate-y-0 group-hover:opacity-100 z-10">
                    <form method="post" action="{% url 'cart_add' p.id %}">
                      {% csrf_token %}
                      <input type="hidden" name="qty" value="1">
                      <button type="submit"
                              class="btn-primary text-xs px-6 py-2.5"
                              title="{% trans 'Quick add to bag' %}">
                        {% trans "Add to Cart" %} +
                      </button>
                    </form>
                  </div>
                {% endif %}
              </div>

              {# Body #}
              <div class="product-card__body">
                <div class="flex items-start justify-between gap-4">
                  <div>
                    <span class="product-card__meta">{{ p.category.name }}</span>
                    <h2 class="product-card__title mt-1">{{ p.name }}</h2>
                  </div>
                  <span class="product-card__price whitespace-nowrap">
                    €{{ p.price }}
                  </span>
                </div>
              </div>
            </a>
          </article>

        {% else %}

          {# ── Standard card ── #}
          <article class="product-card reveal-up">
            <a href="{{ p.get_absolute_url }}" class="block group">

              {# Frame #}
              <div class="product-card__frame">
                <img
                  src="{{ p.image_url_400 }}"
                  srcset="{{ p.image_url_400 }} 400w, {{ p.image_url_800 }} 800w"
                  sizes="(min-width: 1024px) 360px, (min-width: 640px) 50vw, 100vw"
                  alt="{{ p.name }}"
                  loading="lazy"
                  decoding="async"
                >

                {# Sold out badge #}
                {% if not p.is_in_stock %}
                  <div class="absolute top-3 left-3 z-10">
                    <span class="badge badge--sold-out">
                      {% trans "Sold Out" %}
                    </span>
                  </div>
                {% endif %}

                {# Quick add overlay #}
                {% if p.is_in_stock %}
                  <div class="absolute inset-x-0 bottom-0 p-3 z-10
                              translate-y-full opacity-0
                              group-hover:translate-y-0 group-hover:opacity-100
                              transition-all duration-300 ease-out">
                    <form method="post" action="{% url 'cart_add' p.id %}">
                      {% csrf_token %}
                      <input type="hidden" name="qty" value="1">
                      <button type="submit"
                              class="product-card__add w-full justify-center
                                     py-2.5 bg-paper/95 border-ink"
                              title="{% trans 'Quick add to bag' %}">
                        {% trans "Add to Cart" %} +
                      </button>
                    </form>
                  </div>
                {% endif %}
              </div>

              {# Body #}
              <div class="product-card__body">
                <span class="product-card__meta">{{ p.category.name }}</span>
                <h2 class="product-card__title">{{ p.name }}</h2>
                <span class="product-card__price">€{{ p.price }}</span>
              </div>
            </a>
          </article>

        {% endif %}

      {% empty %}
        {# ── Empty state ── #}
        <div class="col-span-full border border-rule bg-surface
                    p-12 text-center">
          <p class="headline-serif text-2xl md:text-3xl">
            {% trans "Nothing here yet" %}
          </p>
          <p class="text-ink-60 mt-3 leading-relaxed">
            {% trans "No products found matching your criteria." %}
          </p>
          <a href="{% url 'product_list' %}" class="btn-outline mt-6 inline-flex">
            {% trans "Clear filters" %}
          </a>
        </div>
      {% endfor %}
    </div>

  </div>
</section>
{% endblock %}